"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = migrateWithMfImport;
const devkit_1 = require("@nx/devkit");
const executor_options_utils_1 = require("@nx/devkit/src/generators/executor-options-utils");
const tsquery_1 = require("@phenomnomnominal/tsquery");
const NX_ANGULAR_MODULE_FEDERATION_IMPORT_SELECTOR = 'ImportDeclaration > StringLiteral[value=@nx/angular/module-federation], VariableStatement CallExpression:has(Identifier[name=require]) > StringLiteral[value=@nx/angular/module-federation]';
const NEW_IMPORT_PATH = `'@nx/module-federation/angular'`;
async function migrateWithMfImport(tree) {
    const projects = new Set();
    (0, executor_options_utils_1.forEachExecutorOptions)(tree, '@nx/angular:webpack-browser', (options, project, target) => {
        const projectConfig = (0, devkit_1.readProjectConfiguration)(tree, project);
        projects.add(projectConfig.root);
    });
    for (const projectRoot of projects) {
        (0, devkit_1.visitNotIgnoredFiles)(tree, projectRoot, (filePath) => {
            if (!filePath.endsWith('.ts') && !filePath.endsWith('.js')) {
                return;
            }
            let contents = tree.read(filePath, 'utf-8');
            if (!contents.includes('@nx/angular/module-federation')) {
                return;
            }
            const ast = tsquery_1.tsquery.ast(contents);
            const importNodes = (0, tsquery_1.tsquery)(ast, NX_ANGULAR_MODULE_FEDERATION_IMPORT_SELECTOR);
            if (importNodes.length === 0) {
                return;
            }
            const importPathNode = importNodes[0];
            contents = `${contents.slice(0, importPathNode.getStart())}${NEW_IMPORT_PATH}${contents.slice(importPathNode.getEnd())}`;
            tree.write(filePath, contents);
        });
    }
    await (0, devkit_1.formatFiles)(tree);
}
