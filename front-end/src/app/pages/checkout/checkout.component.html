<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
    <div class="checkout-container max-w-7xl mx-auto px-3 sm:px-4 md:px-6 lg:px-8 py-4 sm:py-6 lg:py-8">
        <p-toast></p-toast>
        <p-confirmDialog></p-confirmDialog>

        <p-card *ngIf="!checkoutState.isLoading && status.isCartEmpty && status.isIncompleteOrdersEmpty" class="shadow-xl rounded-2xl text-center">
            <ng-template pTemplate="header">
                <div class="p-4 sm:p-6">
                    <i class="pi pi-shopping-cart text-4xl sm:text-5xl md:text-6xl text-gray-300 mb-3 sm:mb-4"></i>
                    <h3 class="text-lg sm:text-xl font-semibold text-gray-600 mb-2">Your cart is empty</h3>
                    <p class="text-sm sm:text-base text-gray-500">Add some items to your cart to get started</p>
                </div>
            </ng-template>
            <ng-template pTemplate="footer">
                <div class="p-4 sm:p-6">
                    <p-button
                            label="Continue Shopping"
                            icon="pi pi-arrow-left"
                            (click)="router.navigate(['/products'])"
                            styleClass="w-full sm:w-auto">
                    </p-button>
                </div>
            </ng-template>
        </p-card>

        <!-- Loading state -->
        <div *ngIf="checkoutState.isLoading" class="flex flex-col items-center justify-center min-h-64 sm:min-h-96">
            <div class="relative">
                <p-progressSpinner strokeWidth="3" class="w-12 h-12 sm:w-16 sm:h-16"></p-progressSpinner>
                <div class="absolute inset-0 rounded-full animate-pulse opacity-20"></div>
            </div>
            <p class="mt-4 sm:mt-6 text-base sm:text-lg font-medium text-gray-700 animate-pulse text-center px-4">Loading checkout...</p>
        </div>

        <!-- Main checkout content -->
        <div *ngIf="!checkoutState.isLoading && !(status.isCartEmpty && status.isIncompleteOrdersEmpty)" class="space-y-4 sm:space-y-6 lg:space-y-8">

            <!-- Header -->
            <div class="p-4 sm:p-6 lg:p-8 border border-gray-200/50 rounded-lg sm:rounded-xl">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <div class="flex items-center space-x-3 sm:space-x-4">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-lg sm:rounded-xl bg-blue-100 flex items-center justify-center">
                            <i class="pi pi-shopping-cart text-lg sm:text-xl text-blue-600"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-gray-900 to-gray-700 bg-clip-text text-transparent">Checkout</h1>
                            <p class="text-gray-500 mt-1 text-sm sm:text-base">Complete your purchase securely</p>
                        </div>
                    </div>
                    <a routerLink="/cart"
                       routerLinkActive="page"
                       ariaCurrentWhenActive="page"
                       class="text-gray-500 hover:text-gray-600 hover:underline transition-colors duration-200 text-sm sm:text-base flex items-center gap-2 sm:self-start">
                        <i class="pi pi-arrow-left"></i>
                        <span class="hidden sm:inline">Back to Cart</span>
                        <span class="sm:hidden">Back</span>
                    </a>
                </div>
            </div>

            <!-- Incomplete Orders -->
            <div *ngIf="checkoutState.incompleteOrders.length > 0" class="overflow-hidden rounded-lg sm:rounded-xl border border-gray-200">
                <div class="bg-gradient-to-r from-orange-50 to-amber-50 border-b border-orange-100 p-4 sm:p-6">
                    <div class="flex flex-col sm:flex-row sm:items-start space-y-3 sm:space-y-0 sm:space-x-3">
                        <div class="w-8 h-8 sm:w-10 sm:h-10 bg-orange-100 rounded-lg sm:rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class="pi pi-exclamation-triangle text-orange-600 text-base sm:text-lg"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-lg sm:text-xl font-semibold text-orange-800 mb-1 sm:mb-2">
                                Incomplete Orders Found
                            </h4>
                            <p class="text-orange-700 leading-relaxed text-sm sm:text-base">
                                You have {{ checkoutState.incompleteOrders.length }} incomplete order(s). Select one to complete your purchase or start a new order.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="p-4 sm:p-6">
                    <p-dropdown
                            [options]="checkoutState.incompleteOrders"
                            [(ngModel)]="checkoutState.selectedOrder"
                            optionLabel="displayName"
                            placeholder="Select an incomplete order to complete"
                            class="w-full [&_.p-dropdown]:!rounded-lg sm:[&_.p-dropdown]:!rounded-xl [&_.p-dropdown]:!border-gray-200 [&_.p-dropdown]:!shadow-lg [&_.p-dropdown]:!transition-all [&_.p-dropdown]:!duration-300 [&_.p-dropdown:hover]:!border-blue-300 [&_.p-dropdown:hover]:!shadow-xl"
                            [showClear]="true"
                            [filter]="checkoutState.incompleteOrders && checkoutState.incompleteOrders.length > 5"
                            filterBy="displayName,email,totalAmount"
                            [virtualScroll]="checkoutState.incompleteOrders && checkoutState.incompleteOrders.length > 10"
                            [virtualScrollItemSize]="60"
                            scrollHeight="300px"
                            (onChange)="handleSelectIncomplete($event)"
                            [loading]="!checkoutState.incompleteOrders"
                            appendTo="body"
                    >
                        <!-- Custom option template -->
                        <ng-template let-order pTemplate="item">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between p-3 sm:p-4 hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 transition-all duration-300 rounded-lg mx-1 sm:mx-2 my-1 gap-3">
                                <div class="flex-1 min-w-0">
                                    <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 mb-2">
                                        <span class="font-semibold text-gray-900 text-base sm:text-lg truncate">
                                            Order #{{ order?.id ? order.id.substring(0, 8) + '...' : 'N/A' }}
                                        </span>
                                        <p-tag
                                                [value]="order?.status || 'Unknown'"
                                                [severity]="getOrderStatusSeverity(order?.status)"
                                                class="text-xs font-medium rounded-full self-start sm:self-auto">
                                        </p-tag>
                                    </div>
                                    <div class="text-xs sm:text-sm text-gray-600 space-y-2">
                                        <div class="flex items-center space-x-1">
                                            <i class="pi pi-envelope text-gray-400 text-xs"></i>
                                            <span class="truncate">{{ order?.email || 'No email' }}</span>
                                        </div>
                                        <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-6">
                                            <span class="font-medium text-green-600 bg-green-50 px-2 py-1 rounded-lg text-xs sm:text-sm inline-block">
                                                {{ order?.totalAmount | currency:(order?.currency || 'USD'):'symbol':'1.2-2' }}
                                            </span>
                                            <span class="text-gray-500 text-xs">{{ order?.createdAt | date:'short' }}</span>
                                            <span *ngIf="order?.orderItems?.length" class="text-xs bg-blue-100 text-blue-700 px-2 sm:px-3 py-1 rounded-full font-medium inline-block">
                                                {{ order.orderItems.length }} item(s)
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between sm:justify-end gap-2 sm:gap-3">
                                    <button
                                            pButton
                                            type="button"
                                            icon="pi pi-eye"
                                            class="p-button-text p-button-sm hover:bg-blue-100 rounded-lg transition-colors duration-200 flex-shrink-0"
                                            pTooltip="View Order Details"
                                            (click)="viewOrderDetails($event, order)"
                                            [style.z-index]="1000">
                                    </button>
                                    <p-tag
                                            [value]="order?.paymentStatus || 'Unknown'"
                                            [severity]="getPaymentStatusSeverity(order?.paymentStatus)"
                                            class="text-xs font-medium rounded-full">
                                    </p-tag>
                                    <i class="pi pi-angle-right text-gray-400 text-base sm:text-lg"></i>
                                </div>
                            </div>
                        </ng-template>

                        <!-- Selected value template -->
                        <ng-template let-order pTemplate="selectedItem">
                            <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-3 py-2" *ngIf="order">
                                <div class="w-6 h-6 sm:w-8 sm:h-8 flex items-center justify-center">
                                    <i class="pi pi-shopping-bag text-xs sm:text-sm"></i>
                                </div>
                                <span class="font-semibold text-gray-900 text-sm sm:text-base truncate">
                                    Order #{{ order?.id ? order.id.substring(0, 8) + '...' : 'N/A' }}
                                </span>
                                <span class="text-xs sm:text-sm font-medium text-green-600 bg-green-50 px-2 py-1 rounded-lg">
                                    {{ order?.totalAmount | currency:(order?.currency || 'USD'):'symbol':'1.2-2' }}
                                </span>
                                <p-tag
                                        [value]="order?.status || 'Unknown'"
                                        [severity]="getOrderStatusSeverity(order?.status)"
                                        class="text-xs font-medium rounded-full">
                                </p-tag>
                                <button
                                        pButton
                                        type="button"
                                        icon="pi pi-eye"
                                        class="p-button-text p-button-sm ml-0 sm:ml-2 hover:bg-gray-100 rounded-lg transition-colors duration-200"
                                        pTooltip="View Order Details"
                                        (click)="viewOrderDetails($event, order)">
                                </button>
                            </div>
                        </ng-template>

                        <!-- Custom dropdown icon -->
                        <ng-template pTemplate="dropdownicon">
                            <div class="w-5 h-5 sm:w-6 sm:h-6 rounded-lg flex items-center justify-center">
                                <i class="pi pi-shopping-cart text-xs sm:text-sm"></i>
                            </div>
                        </ng-template>

                        <!-- Header template -->
                        <ng-template pTemplate="header">
                            <div class="font-semibold p-3 sm:p-4 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-gray-100">
                                <div class="flex items-center space-x-2">
                                    <i class="pi pi-clock text-orange-500 text-base sm:text-lg"></i>
                                    <span class="text-gray-700 text-sm sm:text-base">Incomplete Orders</span>
                                    <span class="bg-orange-100 text-orange-700 px-2 py-1 rounded-full text-xs font-bold">{{ checkoutState.incompleteOrders.length || 0 }}</span>
                                </div>
                            </div>
                        </ng-template>

                        <!-- Empty template -->
                        <ng-template pTemplate="empty">
                            <div class="text-center p-6 sm:p-8 text-gray-500">
                                <div class="w-12 h-12 sm:w-16 sm:h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3 sm:mb-4">
                                    <i class="pi pi-search text-lg sm:text-2xl text-gray-400"></i>
                                </div>
                                <p class="text-base sm:text-lg font-medium">No orders found matching your search</p>
                            </div>
                        </ng-template>
                    </p-dropdown>

                    <!-- Selected Order Actions -->
                    <div *ngIf="checkoutState.selectedOrder" class="mt-4 sm:mt-6 p-4 sm:p-6 border border-blue-200 rounded-lg sm:rounded-xl">
                        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                            <div class="flex-1">
                                <div class="flex flex-col sm:flex-row sm:items-center space-y-2 sm:space-y-0 sm:space-x-3 mb-3">
                                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-blue-500 rounded-lg sm:rounded-xl flex items-center justify-center">
                                        <i class="pi pi-check text-white text-sm sm:text-base"></i>
                                    </div>
                                    <div class="min-w-0">
                                        <h5 class="font-bold text-blue-900 text-base sm:text-lg truncate">
                                            Selected Order: #{{ checkoutState.selectedOrder.id.substring(0, 12) }}...
                                        </h5>
                                        <div class="text-xs sm:text-sm text-blue-700 mt-1 flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-4">
                                            <span class="font-semibold">Total: {{ checkoutState.selectedOrder.totalAmount | currency:(checkoutState.selectedOrder.currency || 'USD'):'symbol':'1.2-2' }}</span>
                                            <span class="hidden sm:inline">•</span>
                                            <span>{{ checkoutState.selectedOrder.orderItems.length || 0 }} item(s)</span>
                                            <span class="hidden sm:inline">•</span>
                                            <span>Created: {{ checkoutState.selectedOrder.createdAt | date:'short' }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                                <button
                                        pButton
                                        type="button"
                                        label="View Details"
                                        icon="pi pi-external-link"
                                        class="p-button-outlined hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5 text-sm rounded-lg"
                                        (click)="viewOrderDetails($event, checkoutState.selectedOrder)">
                                </button>
                                <button
                                        pButton
                                        type="button"
                                        label="Clear Selection"
                                        icon="pi pi-times"
                                        class="p-button-text hover:bg-red-50 hover:text-red-600 transition-colors duration-200 rounded-lg text-sm"
                                        (click)="clearOrderSelection()">
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Form - Only show if no incomplete order is selected -->
            <div *ngIf="checkoutState.isFormNeeded" class="rounded-lg sm:rounded-xl">
                <app-order-form [isReOrdering]="false" [isInCheckout]="true" [initializeStripeElements]="initializeStripeElements" />
            </div>

            <!-- Payment Form - Show when payment is ready (either from new order or selected incomplete order) -->
            <div *ngIf="checkoutState.showPaymentForm" class="overflow-hidden rounded-lg sm:rounded-xl border border-gray-200">
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-b border-green-100 p-4 sm:p-6">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-green-100 rounded-lg sm:rounded-xl flex items-center justify-center">
                            <i class="pi pi-credit-card text-green-600 text-lg sm:text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-xl sm:text-2xl font-bold text-green-800">Payment</h3>
                            <p class="text-green-700 mt-1 text-sm sm:text-base">Secure payment powered by Stripe</p>
                        </div>
                    </div>
                </div>

                <div class="p-4 sm:p-6 lg:p-8">
                    <div class="payment-form space-y-4 sm:space-y-6">
                        <div class="stripe-payment-element p-4 sm:p-6 bg-gray-50 rounded-lg sm:rounded-xl border-2 border-dashed border-gray-200" #paymentElement></div>

                        <div class="payment-actions flex flex-col sm:flex-row gap-3 sm:gap-4">
                            <button
                                    pButton
                                    type="button"
                                    label="Complete Order"
                                    icon="pi pi-credit-card"
                                    [loading]="checkoutState.isProcessingPayment"
                                    [disabled]="checkoutState.isProcessingPayment"
                                    (click)="handlePayment()"
                                    class="flex-1 p-button-success !py-3 sm:!py-4 !text-base sm:!text-lg font-semibold rounded-lg sm:rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-0.5">
                            </button>

                            <button
                                    pButton
                                    type="button"
                                    label="Retry Payment"
                                    icon="pi pi-refresh"
                                    class="p-button-outlined hover:shadow-lg transition-all duration-300 transform hover:-translate-y-0.5 rounded-lg sm:rounded-xl text-sm sm:text-base"
                                    (click)="retryPayment()"
                                    [style.display]="checkoutState.selectedOrder ? 'inline-block' : 'none'">
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="order-summary" *ngIf="checkoutState.orderSummary">
                <div class="overflow-hidden rounded-lg sm:rounded-xl border border-gray-200">
                    <div class="p-4 sm:p-6 bg-gradient-to-r from-purple-50 to-indigo-50 border-b border-purple-100">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-lg sm:rounded-xl bg-purple-100 flex items-center justify-center">
                                <i class="pi pi-list text-lg sm:text-xl text-purple-600"></i>
                            </div>
                            <h3 class="text-xl sm:text-2xl font-bold text-purple-800">Order Summary</h3>
                        </div>
                    </div>

                    <div class="p-4 sm:p-6 lg:p-8">
                        <!-- Items List -->
                        <div class="order-items space-y-3 sm:space-y-4 mb-6 sm:mb-8">
                            <div *ngFor="let item of checkoutState.orderSummary.items" class="order-item flex flex-col sm:flex-row sm:items-center space-y-3 sm:space-y-0 sm:space-x-4 p-3 sm:p-4 bg-gray-50 rounded-lg sm:rounded-xl hover:bg-gray-100 transition-colors duration-200">
                                <div class="item-image flex-shrink-0 self-start sm:self-auto">
                                    <div class="w-12 h-12 sm:w-16 sm:h-16 bg-white rounded-lg sm:rounded-xl border border-gray-200 overflow-hidden shadow-sm">
                                        <img
                                                [src]="getProductImage(item.item.product.id, item.item.media)"
                                                [alt]="item.item.product.name"
                                                class="w-full h-full object-cover">
                                    </div>
                                </div>
                                <div class="item-details flex-1 min-w-0">
                                    <h4 class="font-semibold text-gray-900 text-base sm:text-lg mb-1 sm:mb-2">{{ item.item.product.name }}</h4>
                                    <div class="text-xs sm:text-sm text-gray-600 space-y-1">
                                        <p>Quantity: <span class="font-medium">{{ item.quantity }}</span></p>
                                        <p>Unit Price: <span class="font-medium text-green-600">{{ item.item.product.price | currency }}</span></p>
                                    </div>
                                </div>
                                <div class="item-total text-left sm:text-right">
                                    <div class="text-lg sm:text-xl font-bold text-gray-900">
                                        {{ (item.item.product.price * item.quantity) | currency }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-gray-200 pt-4 sm:pt-6">
                            <!-- Order Totals -->
                            <div class="order-totals space-y-3 sm:space-y-4">
                                <div class="total-row flex justify-between items-center py-2">
                                    <span class="text-gray-600 font-medium text-sm sm:text-base">Subtotal:</span>
                                    <span class="font-semibold text-gray-900 text-sm sm:text-base">{{ checkoutState.orderSummary.subtotal | currency }}</span>
                                </div>
                                <div class="total-row flex justify-between items-center py-2">
                                    <span class="text-gray-600 font-medium text-sm sm:text-base">Shipping:</span>
                                    <span class="font-semibold text-gray-900 text-sm sm:text-base">{{ checkoutState.orderSummary.shipping | currency }}</span>
                                </div>
                                <div class="total-row flex justify-between items-center py-2">
                                    <span class="text-gray-600 font-medium text-sm sm:text-base">Tax:</span>
                                    <span class="font-semibold text-gray-900 text-sm sm:text-base">{{ checkoutState.orderSummary.tax | currency }}</span>
                                </div>
                                <div class="border-t border-gray-200 pt-3 sm:pt-4">
                                    <div class="total-row total-final flex justify-between items-center py-3 sm:py-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg sm:rounded-xl px-4 sm:px-6">
                                        <span class="text-lg sm:text-xl font-bold text-gray-900">Total:</span>
                                        <span class="text-xl sm:text-2xl font-bold text-green-600">{{ checkoutState.orderSummary.total | currency }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Security Badge -->
                            <div class="security-badge flex items-center justify-center space-x-2 mt-6 sm:mt-8 p-3 sm:p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg sm:rounded-xl">
                                <div class="w-6 h-6 sm:w-8 sm:h-8 bg-green-500 rounded-lg flex items-center justify-center">
                                    <i class="pi pi-lock text-white text-sm sm:text-base"></i>
                                </div>
                                <span class="font-medium text-gray-700 text-sm sm:text-base">Secure checkout powered by Stripe</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>